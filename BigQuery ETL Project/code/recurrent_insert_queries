-- Insert into the customer table from the staging table
INSERT INTO 
    d607pa2-456203.ecommerce.customer (customer_id, name, email, phone, address)
SELECT DISTINCT
    customer.customer_id,
    customer.name,
    customer.email,
    customer.phone,
    customer.address
FROM
    d607pa2-456203.ecommerce.staging 
WHERE customer.customer_id IS NOT NULL
AND customer.customer_id NOT IN (SELECT customer_id FROM d607pa2-456203.ecommerce.customer);

-- Insert into shopping_cart table from the staging table

INSERT INTO 
    d607pa2-456203.ecommerce.shopping_cart (transaction_id, product_id, vendor, product_category, product_name, quantity, price)
SELECT
    staging.transaction_id,
    sc.product_id,
    sc.vendor,
    sc.product_category,
    sc.product_name,
    CAST(sc.quantity AS INT64),
    CAST(sc.price AS FLOAT64)
FROM
    d607pa2-456203.ecommerce.staging AS staging,
    UNNEST(staging.shopping_cart) AS sc
WHERE NOT EXISTS (
    SELECT 1
    FROM d607pa2-456203.ecommerce.shopping_cart AS existing_cart
    WHERE existing_cart.transaction_id = staging.transaction_id
    AND existing_cart.product_id = sc.product_id);

-- Insert into the transaction table from the staging table

INSERT INTO 
    d607pa2-456203.ecommerce.transaction (transaction_id, customer_id, transaction_date, shipping_method, total_amount)
SELECT
    transaction_id,
    customer.customer_id,
    CAST(transaction_date AS TIMESTAMP),
    shipping_method,
    CAST(total_amount AS FLOAT64)
FROM
    d607pa2-456203.ecommerce.staging
WHERE 
    staging.transaction_id NOT IN (SELECT transaction_id FROM d607pa2-456203.ecommerce.transaction);
